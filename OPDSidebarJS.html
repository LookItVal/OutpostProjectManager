<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
  // Run initializations on sidebar load.
  $(function() {
    // Assign handler functions to sidebar elements here, if needed.
    $('#project-refresh-button').click(refreshSidebar);
    $('#jump-to-job-button').click(jumpToJob);
    $('#jump-to-proposals-button').click(jumpToProposal);
    $('#create-proposal-button').click(requestProposalGeneration);
    refreshSidebar();
    // Call the server here to retrieve any information needed to build
    // the dialog, if necessary.
  });

  // Update the ui to show loading info and remove dynamic content.
  function loading() {
    $('#project-title').text("Loading...");
    $('.existing-job').fadeOut();
    $('.new-job').fadeOut();
    $('.info-message').fadeOut();
    $('.existing-proposal').fadeOut();
    $('.new-proposal').fadeOut();
  }

  // Get the current project info from the server and display the appropriate dynamic content.
  function refreshSidebar() {
    loading();
    google.script.run.withSuccessHandler(function(initiative) {
      console.log(initiative);
      $('#project-title').text(initiative.title);
      if (!initiative.type) {
        $('#info-text').text('Fill out the sheet with information then hit load project to refresh.');
        $('.info-message').fadeIn();
      } else if (initiative.type === "PROJECT") {
        if (initiative.sheetId === null) {
          $('.new-job').fadeIn();
        } else {
          $('.existing-job').fadeIn();
        }
      } else if (initiative.type === "PROPOSAL") {
        if (initiative.status === "NEW") {
          $('.new-proposal').fadeIn();
        } else if (initiative.status === "ACTIVE") {
          populateProposal(initiative);
        }
      }
    }).withFailureHandler(function(msg, element) {
      console.log(msg, element);
      $('#project-title').text("Error With Addon: Check Frontend Console For Details")
    }).getProject();
  }

  function populateProposal(proposal) {
    $('.existing-proposal').fadeIn();
  }

  // Calls the server to change the active sheet to the most recent job.
  function jumpToJob() {
    loading();
      google.script.run
      .withFailureHandler(function(msg, element) {
        console.log(msg, element);
        element.disabled = false;
      })
      .withSuccessHandler(function() {
        refreshSidebar();
      })
      .jumpToJob();
  }
  
  // Calls The server to change the active sheet to the proposal sheet.
  function jumpToProposal() {
    loading();
    google.script.run
      .withFailureHandler(function(msg, element) {
        console.log(msg, element);
        element.disabled = false;
      })
      .withSuccessHandler(function() {
        refreshSidebar();
      })
      .jumpToProposal();
  }

  // Calls the server to generate a new proposal.
  function requestProposalGeneration() {
    google.script.run
      .withFailureHandler(function(msg, element) {
        console.log(msg, element);
        element.disabled = false;
      })
      .withSuccessHandler(function(result) {
        if (result) {
          $('#project-title').text("Proposal Being Generated...");
          $('#info-text').text('Please wait while the proposal is generated. This may take a few moments.');
          $('.new-proposal').fadeOut();
          $('.info-message').fadeIn();
          generateProposal();
        }
      })
      .requestProposalGeneration();
  }

  function generateProposal() {
    google.script.run
      .withFailureHandler(function(msg, element) {
        $('#info-text').text('An error occured. Please check the console for details.');
        console.log(msg, element);
        element.disabled = false;
      })
      .withSuccessHandler(function() {
        refreshSidebar();
      })
      .generateProposal();
  }
</script>