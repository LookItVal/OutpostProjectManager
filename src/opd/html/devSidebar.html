<button id="benchmark-button" class="create full-width row">
  <span class="material-symbols-outlined">
    speed
  </span>
  Run Benchmark
  <span class="material-symbols-outlined">
    speed
  </span>
</button>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
  $(function() {
    $('#benchmark-button').click(requestBenchmark);
  });

  function throwError(error) {
    throw new Error(error.message);
  }
  
  async function requestBenchmark() {
    let iterationCount = askForIterationCount();
    let result = confirm('Are you sure you want to run the benchmark ' + iterationCount + ' times?');
    if (result == false) {
      console.warn('Benchmark Haulted');
      return;
    }
    let fullBenchmark = {
      'OPDSheet': {
        'Frontend': {}
      }
    }
    while(iterationCount > 0) {
      let results = await runBenchmarkTests();
      console.debug('Benchmark results:', results);
      mergeBenchmarkResults(fullBenchmark, results);
      iterationCount--;
      await jumpToProposal();
    }
    toastr.success('Benchmark complete:', fullBenchmark);
    console.debug('Benchmark complete:', fullBenchmark);
  }

  function askForIterationCount() {
    var iterationCount = prompt('How many iterations would you like to run?');
    if (typeof iterationCount !== 'number') {
      iterationCount = parseInt(iterationCount);
      if (iterationCount == NaN) {
        alert('Invalid input. Please enter a number.');
        return askForIterationCount();
      }
    }
    if (iterationCount <= 0) {
      alert('Invalid input. Please enter a positive number.');
      return askForIterationCount();
    }
    return iterationCount;
  }

  function mergeBenchmarkResults(fullBenchmark, results) {
    for (const key of Object.keys(results)) {
      if (fullBenchmark['OPDSheet']['Frontend'][key]) {
        fullBenchmark['OPDSheet']['Frontend'][key]['Raw'].push(results[key]);
      } else {
        fullBenchmark['OPDSheet']['Frontend'][key] = {
          'Raw': [results[key]]
        }
      }
    }
    return fullBenchmark; 
  }

  async function benchmarkFunction(func) {
    benchmarkNextFunction = true;
    let start = performance.now();
    await func();
    let end = performance.now();
    return end - start;
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function runBenchmarkTests() {
    try {
      let results = {};
      results['jumpToProjects'] = await benchmarkFunction(jumpToProject);
      console.debug('jumpToProjects', results['jumpToProjects']);
      toastr.success('jumpToProjects', results['jumpToProjects']);

      startLoading('Selecting Empty Project');
      await selectEmptyProject();
      await sleep(5000);
      stopLoading();
      results['getInitiative from empty project'] = await benchmarkFunction(refreshSidebar);
      console.debug('getInitiative from empty project', results['getInitiative from empty project']);
      toastr.success('getInitiative from empty project', results['getInitiative from empty project']);

      startLoading('Filling in Blank Information');
      await selectNoDocsProject();
      await sleep(5000);
      stopLoading();
      results['getInitiative from project with no docs'] = await benchmarkFunction(refreshSidebar);
      console.debug('getInitiative from project with no docs', results['getInitiative from project with no docs']);
      toastr.success('getInitiative from project with no docs', results['getInitiative from project with no docs']);

      startLoading('Prepare to Generate Project');
      await sleep(1000);
      stopLoading();
      results['generateProject from existing client'] = await benchmarkFunction(generateJob);
      console.debug('generateProject from existing client', results['generateProject from existing client']);
      toastr.success('generateProject from existing client', results['generateProject from existing client']);

      startLoading('Preparing to Reload Project');
      await sleep(1000);
      stopLoading();
      results['getInitiative from project with all docs'] = await benchmarkFunction(refreshSidebar);
      console.debug('getInitiative from project with all docs', results['getInitiative from project with all docs']);
      toastr.success('getInitiative from project with all docs', results['getInitiative from project with all docs']);
      
      startLoading('Deleting Project and Client Files');
      await deleteProjectFiles();
      await deleteClientFiles();
      await selectNoDocsProject();
      await sleep(5000);
      stopLoading();
      results['generateProject from new client'] = await benchmarkFunction(generateJob);
      console.debug('generateProject from new client', results['generateProject from new client']);
      toastr.success('generateProject from new client', results['generateProject from new client']);

      startLoading('Deleting Project Files');
      await deleteProjectFiles();
      // delete the text here too in another function, or maybe just the one function
      stopLoading();
      results['jumpToProposals'] = await benchmarkFunction(jumpToProposal);
      console.debug('jumpToProposals', results['jumpToProposals']);
      toastr.success('jumpToProposals', results['jumpToProposals']);

      startLoading('Selecting Empty Proposal');
      await selectEmptyProposal();
      await sleep(5000);
      stopLoading();
      results['getInitiative from empty proposal'] = await benchmarkFunction(refreshSidebar);
      console.debug('getInitiative from empty proposal', results['getInitiative from empty proposal']);
      toastr.success('getInitiative from empty proposal', results['getInitiative from empty proposal']);

      startLoading('Filling in Blank Information');
      await selectNoDocsProposal();
      await sleep(5000);
      stopLoading();
      results['getInitiative from proposal with no docs'] = await benchmarkFunction(refreshSidebar);
      console.debug('getInitiative from proposal with no docs', results['getInitiative from proposal with no docs']);
      toastr.success('getInitiative from proposal with no docs', results['getInitiative from proposal with no docs']);

      startLoading('Prepare to Generate Proposal');
      await sleep(1000);
      stopLoading();
      results['generateProposal from existing client'] = await benchmarkFunction(generateProposal);
      console.debug('generateProposal from existing client', results['generateProposal from existing client']);
      toastr.success('generateProposal from existing client', results['generateProposal from existing client']);

      startLoading('Preparing to Reload Proposal');
      await sleep(1000);
      stopLoading();
      results['getInitiative from proposal with all docs'] = await benchmarkFunction(refreshSidebar);
      console.debug('getInitiative from proposal with all docs', results['getInitiative from proposal with all docs']);
      toastr.success('getInitiative from proposal with all docs', results['getInitiative from proposal with all docs']);

      startLoading('Deleting Proposal and Client Files');
      await deleteProposalFiles();
      await deleteClientFiles();
      await selectNoDocsProposal();
      await sleep(5000);
      stopLoading();
      results['generateProposal from new client'] = await benchmarkFunction(generateProposal);
      console.debug('generateProposal from new client', results['generateProposal from new client']);
      toastr.success('generateProposal from new client', results['generateProposal from new client']);

      startLoading('Prepare to Accept Proposal');
      await sleep(1000);
      stopLoading();
      results['acceptProposal'] = await benchmarkFunction(acceptProposal);
      console.debug('acceptProposal', results['acceptProposal']);
      toastr.success('acceptProposal', results['acceptProposal']);

      startLoading('Deleting Project Files');
      await deleteProjectFiles();
      stopLoading();

      results['openChangelog'] = await benchmarkFunction(openChangelog);
      console.debug('openChangelog', results['openChangelog']);
      toastr.success('openChangelog', results['openChangelog']);

      return results;
    }  catch (error) {
      stopLoading();
      console.error('Error selecting empty project: ' + error.message);
      alert('Error selecting empty project: ' + error.message);
      return;
    }
  }

  async function selectEmptyProject() {
    await googleScript(()=>{}, 'selectEmptyProject', [], throwError);
  }

  async function selectEmptyProposal() {
    await googleScript(()=>{}, 'selectEmptyProposal', [], throwError);
  }

  async function selectFullProject() {
    await googleScript(()=>{}, 'selectFullProject', [], throwError);
  }

  async function selectFullProposal() {
    await googleScript(()=>{}, 'selectFullProposal', [], throwError);
 }

  async function selectNoDocsProject() {
    await googleScript(()=>{}, 'selectNoDocsProject', [], throwError);
  }

  async function selectNoDocsProposal() {
    await googleScript(()=>{}, 'selectNoDocsProposal', [], throwError);
  }

  async function selectNewProjectFromExistingClient() {
    await googleScript(()=>{}, 'selectNewProjectFromExistingClient', [], throwError);
  }

  async function deleteProject() {
    await googleScript(()=>{}, 'deleteProject', [], throwError);
  }

  async function deleteClientFiles() {
    await googleScript(()=>{}, 'deleteClientFiles', [], throwError);
  }

  async function selectNewProposal() {
    await googleScript(()=>{}, 'selectNewProposal', [], throwError);
  }

  async function deleteProposalFiles() {
    await googleScript(()=>{}, 'deleteProposalFiles', [], throwError);
  }

  async function deleteProjectFiles() {
    await googleScript(()=>{}, 'deleteProjectFiles', [], throwError);
  }
</script>